# Nightly Hibernate
# Scales down all Container Apps and stops PostgreSQL + RabbitMQ to minimize costs
# Runs every night at 23:00 CET (22:00 UTC)

name: Nightly Hibernate

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  RESOURCE_GROUP: eshop-prod-rg
  PREFIX: eshop

jobs:
  hibernate:
    name: Hibernate Environment
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Azure Login (OIDC)
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Hibernate
        run: ./tools/azure/hibernate.sh "${{ env.RESOURCE_GROUP }}" "${{ env.PREFIX }}" --yes

      - name: Summary
        run: |
          echo "## Nightly Hibernate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Container Apps: scaled to 0 replicas" >> $GITHUB_STEP_SUMMARY
          echo "- RabbitMQ: stopped" >> $GITHUB_STEP_SUMMARY
          echo "- PostgreSQL: stopped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To wake up, run \`./tools/azure/warm-up.sh ${{ env.RESOURCE_GROUP }} ${{ env.PREFIX }}\`" >> $GITHUB_STEP_SUMMARY
