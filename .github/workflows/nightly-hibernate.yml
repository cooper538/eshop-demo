# Nightly Hibernate
# Deletes all Container Apps and stops PostgreSQL to minimize costs
# Runs every night at 23:00 CET (22:00 UTC)

name: Nightly Hibernate

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  RESOURCE_GROUP: eshop-prod-rg
  PREFIX: eshop

jobs:
  hibernate:
    name: Hibernate Environment
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v4

      - name: Azure Login (OIDC)
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Delete Container Apps
        run: |
          APPS="gateway product-service order-service notification-service analytics-service rabbitmq"
          for app in $APPS; do
            echo "Deleting ${{ env.PREFIX }}-${app}..."
            az containerapp delete \
              --name "${{ env.PREFIX }}-${app}" \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --yes --output none 2>/dev/null || true
          done

          echo "Deleting migration job..."
          az containerapp job delete \
            --name "${{ env.PREFIX }}-migration" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --yes --output none 2>/dev/null || true

      - name: Stop PostgreSQL
        run: |
          PG_NAME=$(az postgres flexible-server list \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --query "[0].name" -o tsv 2>/dev/null)
          if [ -n "$PG_NAME" ]; then
            PG_STATE=$(az postgres flexible-server show \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --name "$PG_NAME" --query state -o tsv 2>/dev/null) || true
            if [[ "$PG_STATE" != "Stopped" ]]; then
              echo "Stopping $PG_NAME..."
              az postgres flexible-server stop \
                --resource-group "${{ env.RESOURCE_GROUP }}" \
                --name "$PG_NAME" --output none
            fi
          fi

      - name: Summary
        run: |
          echo "## Nightly Hibernate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Container Apps: **deleted** (will be recreated on next deploy)" >> $GITHUB_STEP_SUMMARY
          echo "- Migration Job: **deleted**" >> $GITHUB_STEP_SUMMARY
          echo "- PostgreSQL: **stopped**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To wake up, run \`./tools/azure/warm-up.sh\` or trigger the Infrastructure + Application workflows" >> $GITHUB_STEP_SUMMARY
