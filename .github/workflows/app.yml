# Application Deployment
# Builds Docker images, pushes to GHCR, and deploys to Azure Container Apps

name: Application

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - '.github/workflows/app.yml'
  workflow_dispatch:
    inputs:
      skip_deploy:
        description: 'Build images only, skip deployment'
        type: boolean
        default: false

concurrency:
  group: app-${{ github.ref }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/eshop
  # Must match infra/main.bicep naming convention
  PREFIX: eshop
  ENVIRONMENT: prod
  RESOURCE_GROUP: eshop-prod-rg  # ${PREFIX}-${ENVIRONMENT}-rg
  CONTAINER_ENV: eshop-env       # ${PREFIX}-env

jobs:
  build:
    name: Build ${{ matrix.service.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - name: gateway
            dockerfile: src/Services/Gateway/Gateway.API/Dockerfile
            image: gateway
          - name: products
            dockerfile: src/Services/Products/Products.API/Dockerfile
            image: products
          - name: order
            dockerfile: src/Services/Order/Order.API/Dockerfile
            image: order
          - name: notification
            dockerfile: src/Services/Notification/Dockerfile
            image: notification
          - name: analytics
            dockerfile: src/Services/Analytics/Dockerfile
            image: analytics
          - name: migration
            dockerfile: src/Services/DatabaseMigration/Dockerfile
            image: migration
    outputs:
      image_tag: ${{ github.sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.service.dockerfile }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service.image }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service.image }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  migrate:
    name: Run Migrations
    runs-on: ubuntu-latest
    needs: build
    if: ${{ !inputs.skip_deploy }}
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Run Migration Job
        run: |
          # Create or update migration job
          az containerapp job create \
            --name eshop-migration \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --environment ${{ env.CONTAINER_ENV }} \
            --trigger-type Manual \
            --replica-timeout 300 \
            --replica-retry-limit 1 \
            --replica-completion-count 1 \
            --parallelism 1 \
            --image ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/migration:${{ github.sha }} \
            --registry-server ${{ env.REGISTRY }} \
            --registry-username ${{ secrets.GHCR_USERNAME }} \
            --registry-password ${{ secrets.GHCR_TOKEN }} \
            --cpu 0.25 \
            --memory 0.5Gi \
            --secrets "postgres-connection=secretref:postgres-connection-string" \
            --env-vars "ConnectionStrings__DefaultConnection=secretref:postgres-connection" \
            2>/dev/null || \
          az containerapp job update \
            --name eshop-migration \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/migration:${{ github.sha }}

          # Start migration job and wait for completion
          echo "Starting migration job..."
          execution=$(az containerapp job start \
            --name eshop-migration \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query name -o tsv)

          echo "Waiting for migration to complete..."
          for i in {1..30}; do
            status=$(az containerapp job execution show \
              --name eshop-migration \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --job-execution-name "$execution" \
              --query properties.status -o tsv 2>/dev/null || echo "Running")

            echo "Status: $status"

            if [[ "$status" == "Succeeded" ]]; then
              echo "Migration completed successfully"
              exit 0
            elif [[ "$status" == "Failed" ]]; then
              echo "Migration failed"
              exit 1
            fi

            sleep 10
          done

          echo "Migration timed out"
          exit 1

  deploy:
    name: Deploy ${{ matrix.service.name }}
    runs-on: ubuntu-latest
    needs: [build, migrate]
    if: ${{ !inputs.skip_deploy }}
    environment: production
    strategy:
      fail-fast: false
      matrix:
        service:
          - name: gateway
            app: eshop-gateway
            image: gateway
          - name: products
            app: eshop-product-service
            image: products
          - name: order
            app: eshop-order-service
            image: order
          - name: notification
            app: eshop-notification-service
            image: notification
          - name: analytics
            app: eshop-analytics-service
            image: analytics
    steps:
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to Container Apps
        run: |
          az containerapp update \
            --name ${{ matrix.service.app }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service.image }}:${{ github.sha }}

      - name: Verify Deployment
        run: |
          echo "## ${{ matrix.service.name }} Deployment" >> $GITHUB_STEP_SUMMARY

          # Get revision info
          revision=$(az containerapp revision list \
            --name ${{ matrix.service.app }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query '[0].name' -o tsv)

          echo "Active revision: $revision" >> $GITHUB_STEP_SUMMARY

          # Get FQDN for gateway
          if [[ "${{ matrix.service.name }}" == "gateway" ]]; then
            fqdn=$(az containerapp show \
              --name ${{ matrix.service.app }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --query 'properties.configuration.ingress.fqdn' -o tsv)
            echo "Gateway URL: https://$fqdn" >> $GITHUB_STEP_SUMMARY
          fi

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: deploy
    if: ${{ !inputs.skip_deploy && always() }}
    steps:
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Generate Summary
        run: |
          echo "# Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get gateway URL
          fqdn=$(az containerapp show \
            --name eshop-gateway \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query 'properties.configuration.ingress.fqdn' -o tsv 2>/dev/null || echo "N/A")

          echo "## Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "- Gateway: https://$fqdn" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Services Status" >> $GITHUB_STEP_SUMMARY
          for app in eshop-gateway eshop-product-service eshop-order-service eshop-notification-service eshop-analytics-service; do
            status=$(az containerapp show \
              --name $app \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --query 'properties.runningStatus' -o tsv 2>/dev/null || echo "Unknown")
            echo "- $app: $status" >> $GITHUB_STEP_SUMMARY
          done
