#!/bin/bash

# Pre-commit hook for C# code formatting
# This hook automatically formats staged .cs files using CSharpier.
# Full CI validation (dotnet format) runs in pre-push hook.

set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get list of staged .cs files
STAGED_CS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.cs$' || true)

# Exit early if no C# files are staged
if [ -z "$STAGED_CS_FILES" ]; then
    exit 0
fi

echo -e "${YELLOW}CSharpier: Formatting staged C# files...${NC}"

# Check if dotnet tools are restored
if ! dotnet tool list | grep -q "csharpier"; then
    echo -e "${YELLOW}CSharpier not found. Running dotnet tool restore...${NC}"
    dotnet tool restore
fi

# Format all staged files at once (much faster than per-file)
echo "$STAGED_CS_FILES" | xargs dotnet csharpier format 2>/dev/null

# Re-stage any files that were modified
for FILE in $STAGED_CS_FILES; do
    if [ -f "$FILE" ] && ! git diff --quiet "$FILE" 2>/dev/null; then
        git add "$FILE"
    fi
done

echo -e "${GREEN}CSharpier: Done!${NC}"
exit 0
