# yaml-language-server: $schema=./Configuration/gateway.settings.schema.json
# Gateway Service Configuration
# Environment-specific overrides: gateway.settings.{Environment}.yaml

AllowedHosts: "*"

Serilog:
  MinimumLevel:
    Default: "Information"
    Override:
      Microsoft: "Warning"
      Microsoft.AspNetCore: "Warning"
      Microsoft.AspNetCore.Hosting: "Information"
      Microsoft.Hosting.Lifetime: "Information"
      System: "Warning"
      Yarp: "Information"

Gateway:
  Service:
    Name: "Gateway"

  # JWT Bearer authentication (disabled by default for development)
  Authentication:
    Enabled: false
    AzureAd:
      Instance: "https://login.microsoftonline.com/"
      TenantId: "{your-tenant-id}"
      ClientId: "{your-client-id}"
      Audience: "api://eshop-api"

  RateLimiting:
    Enabled: true
    PermitLimit: 100
    WindowSeconds: 60
    QueueLimit: 0

  OutputCache:
    ProductsListCacheMinutes: 5
    SwaggerCacheMinutes: 1440  # 24h

ReverseProxy:
  Routes:
    # Swagger/OpenAPI routes (cached 24h)
    products-swagger-route:
      ClusterId: "product-cluster"
      OutputCachePolicy: "SwaggerCache"
      Match:
        Path: "/api/products/swagger/{**catch-all}"

    orders-swagger-route:
      ClusterId: "order-cluster"
      OutputCachePolicy: "SwaggerCache"
      Match:
        Path: "/api/orders/swagger/{**catch-all}"

    # GET /api/products - list cached 5 min
    products-read-route:
      ClusterId: "product-cluster"
      RateLimiterPolicy: "fixed"
      OutputCachePolicy: "ProductsCache"
      Match:
        Path: "/api/products/{**catch-all}"
        Methods: ["GET"]

    products-read-exact-route:
      ClusterId: "product-cluster"
      RateLimiterPolicy: "fixed"
      OutputCachePolicy: "ProductsCache"
      Match:
        Path: "/api/products"
        Methods: ["GET"]

    # POST/PUT/DELETE /api/products - no cache
    products-write-route:
      ClusterId: "product-cluster"
      RateLimiterPolicy: "fixed"
      Match:
        Path: "/api/products/{**catch-all}"
        Methods: ["POST", "PUT", "DELETE"]

    products-write-exact-route:
      ClusterId: "product-cluster"
      RateLimiterPolicy: "fixed"
      Match:
        Path: "/api/products"
        Methods: ["POST", "PUT", "DELETE"]

    orders-route:
      ClusterId: "order-cluster"
      RateLimiterPolicy: "fixed"
      Match:
        Path: "/api/orders/{**catch-all}"

    orders-exact-route:
      ClusterId: "order-cluster"
      RateLimiterPolicy: "fixed"
      Match:
        Path: "/api/orders"

  Clusters:
    product-cluster:
      HttpRequest:
        ActivityTimeout: "00:00:30"  # 30s request timeout
      HealthCheck:
        Active:
          Enabled: true
          Interval: "00:00:10"
          Timeout: "00:00:05"
          Path: "/health"
      Destinations:
        product-service:
          Address: "http://product-service"

    order-cluster:
      HttpRequest:
        ActivityTimeout: "00:00:30"  # 30s request timeout
      HealthCheck:
        Active:
          Enabled: true
          Interval: "00:00:10"
          Timeout: "00:00:05"
          Path: "/health"
      Destinations:
        order-service:
          Address: "http://order-service"
